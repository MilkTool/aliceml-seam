#!/bin/sh

prefix=@prefix@
exec_prefix=@exec_prefix@

if [ $# -lt 1 ]; then
    echo "usage: $0 [--verbose|-v] (cc|c++|ld) <option> ..." >&2
    exit 2
fi

case `uname -s` in
    CYGWIN*)
	platform=windows
	;;
    *)
	platform=unix
	;;
esac

mode=$1; shift
case "$mode" in
    --verbose|-v)
	verbose=1
	mode=$1; shift
	;;
    *)
	verbose=0
	;;
esac

cmd() {
    if [ "$verbose" -ne 0 ]; then echo "$@"; fi
    "$@" || exit $?
}

case "$mode" in
    c++)
	if [ "$platform" = windows ]; then
	    cxxflags=-mno-cygwin
	else
	    cxxflags=-fPIC
	fi
	cmd @CXX@ $cxxflags -DLIGHTNING=@HAVE_LIGHTNING@ \
	    -I@includedir@/seam "$@"
	;;
    ld)
	outputfile=""
	ldflags=""
	libs=""
	fileargs=""
	while [ $# -gt 0 ]; do
	    case $1 in
		-o)
		    if [ -z "$outputfile" ]; then
			outputfile="$2"; shift; shift
		    else
			echo $0: option -o given more than once >&2
			exit 2
		    fi
		    ;;
		-s)
		    ldflags="$ldflags $1"; shift
		    ;;
		-l*|-L*|*.dll)
		    libs="$libs $1"; shift
		    ;;
		*)
		    fileargs="$fileargs $1"; shift
		    ;;
	    esac
	done
	libs="$libs @bindir@/seam.dll"
	if [ "$platform" = windows ]; then
	    ldflags="-mno-cygwin $ldflags"
	fi
	cmd @CXX@ -shared $ldflags -o $outputfile $fileargs $libs
	;;
    *)
	echo $0: unknown mode \`$1\' >&2
	exit 2
	;;
esac

exit 0
