## @configure_input@
##
## Author:
##   Leif Kornstaedt <kornstae@ps.uni-sb.de>
## 
## Copyright:
##   Leif Kornstaedt, 2000-2003
## 
## Last change:
##   $Date$ by $Author$
##   $Revision$
## 

srcdir = @srcdir@
VPATH = @srcdir@

BUILDTOP = .
SRCTOP = $(srcdir)

include $(BUILDTOP)/Makefile.vars
include $(SRCTOP)/Makefile.rules

SUBDIRS = generic adt store

SOURCES = Base.cc InitSeam.cc SeamMain.cc
OBJS = $(SOURCES:%.cc=%.o)

@SET_MAKE@

##
## Enumerate seam.dll files
##
STORE_SOURCES = Map.cc WeakMap.cc Heap.cc Store.cc JITStore.cc
STORE_OBJS = $(STORE_SOURCES:%.cc=store/%.o)
ADT_SOURCES = ChunkMap.cc Outline.cc
ADT_OBJS = $(ADT_SOURCES:%.cc=adt/%.o)
GENERIC_SOURCES = \
	Outline.cc Debug.cc RootSet.cc UniqueString.cc \
	StackFrame.cc TaskStack.cc IOHandler.cc IODesc.cc SignalHandler.cc \
	Scheduler.cc Transients.cc Worker.cc Interpreter.cc \
	Primitive.cc PushCallWorker.cc BindFutureWorker.cc \
	Unpickler.cc Pickler.cc Profiler.cc Broker.cc
GENERIC_OBJS = $(GENERIC_SOURCES:%.cc=generic/%.o)
SEAM_OBJS = $(STORE_OBJS) $(ADT_OBJS) $(GENERIC_OBJS)

##
## Include Files for the Foreign Function Interface
##
TOPINCLUDEFILES0 = \
	Base.hh Seam.hh
STOREINCLUDEFILES0 = \
	Base.hh Types.hh StoreConfig.hh HeaderOp.hh PointerOp.hh \
	StatusWord.hh Value.hh Map.hh WeakMap.hh Store.hh BaseMap.hh \
	BaseMap.cc MapNode.hh Heap.hh JITStore.hh
ADTINCLUDEFILES0 = \
	IntMap.hh ChunkMap.hh Queue.hh Stack.hh
GENERICINCLUDEFILES0 = \
	FinalizationSet.hh Transform.hh ConcreteRepresentationHandler.hh \
	ConcreteRepresentation.hh ConcreteCode.hh Closure.hh Thread.hh \
	ThreadQueue.hh Tuple.hh String.hh StackFrame.hh Backtrace.hh \
	Pickle.hh Float.hh Double.hh Debug.hh RootSet.hh UniqueString.hh \
	TaskStack.hh IOHandler.hh IODesc.hh SignalHandler.hh \
	Scheduler.hh Transients.hh Worker.hh Interpreter.hh Primitive.hh \
	PushCallWorker.hh BindFutureWorker.hh Unpickler.hh Pickler.hh \
	Profiler.hh Broker.hh Authoring.hh JitterGenericData.hh
INCLUDEFILES = \
	$(TOPINCLUDEFILES0) \
	$(STOREINCLUDEFILES0:%=store/%) \
	$(ADTINCLUDEFILES0:%=adt/%) \
	$(GENERICINCLUDEFILES0:%=generic/%)
##
## Done
##

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
includedir = @includedir@
INSTALLDIRS = \
	$(bindir) \
	$(includedir)/seam/store $(includedir)/seam/adt \
	$(includedir)/seam/generic
BINS = seam.exe seam.dll seamtool
INSTALLFILES = $(BINS:%=$(bindir)/%) $(INCLUDEFILES:%=$(includedir)/seam/%)
INSTALL = @INSTALL@

.PHONY: $(SUBDIRS) clean-local veryclean-local distclean-local install

all: seam.exe

$(SUBDIRS): %:
	(cd $@ && $(MAKE) all)

seam.dll: Base.o InitSeam.o store adt generic
	$(LD) $(LDFLAGS) -shared -o $@ Base.o InitSeam.o $(SEAM_OBJS) $(LIBS)

seam.exe: SeamMain.o seam.dll
	$(LD) $(LDFLAGS) -o $@ $< seam.dll

clean: clean-local
	for i in $(SUBDIRS); do (cd $$i && $(MAKE) clean) || exit 1; done
veryclean: veryclean-local
	for i in $(SUBDIRS); do (cd $$i && $(MAKE) veryclean) || exit 1; done
distclean: distclean-local
	for i in $(SUBDIRS); do (cd $$i && $(MAKE) distclean) || exit 1; done

clean-local:
	rm -f $(OBJS)
veryclean-local: clean-local
	rm -f seam.dll
distclean-local: veryclean-local
	rm -f Makefile.depend

install: $(INSTALLDIRS) $(INSTALLFILES)

$(INSTALLDIRS): %:
	mkdir -p $@

$(bindir)/%: %
	$(INSTALL) -m 555 $< $@

$(includedir)/seam/%: %
	$(INSTALL) -m 444 $< $@

%: %.in config.status
	./config.status $@

Makefile.depend: Makefile $(SOURCES) store/StoreConfig.hh
	$(MAKEDEPEND) $(SOURCES:%=$(srcdir)/%) > Makefile.depend

store/StoreConfig.hh:
	cd store && make StoreConfig.hh

include Makefile.depend
